#! /usr/bin/perl

# Using Mojolicious::Lite will enable "strict" and "warnings"
use Mojolicious::Lite;
use Tapper::Model 'model';
use Tapper::Config;
use Log::Log4perl;
use 5.010;

# go into background
use App::Daemon qw( daemonize );
daemonize();

# initialize logging
Log::Log4perl->init(Tapper::Config->subconfig->{files}{log4perl_cfg});

get '/state/:state/(*optional)' => sub {
        my $self      = shift;
        my %params    = @{$self->tx->req->url->path->parts || []};
        
        my $db = model('TestrunDB')->resultset('Message')->new({testrun_id => $params{testrun_id},
                                                                type       => 'state',
                                                                message    => \%params});

        $db->insert;
        $self->render(text => '');
};

# start the Mojolicious command system
my $port = Tapper::Config::subconfig->{mcp_port} || 7359;
app->secret('Tapper::MCP::MessageReceiver');
if (@ARGV) {
        app->start;
} else {
        app->start("daemon", "--listen", "http://*:$port");
}
